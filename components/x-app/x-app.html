<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../unit-doll/unit-doll.html">
<link rel="import" href="../text-string/text-string.html">
<link rel="import" href="../tab-group/tab-group.html">
<link rel="import" href="../unit-browse/unit-browse.html">
<link rel="import" href="../unit-saved/unit-saved.html">
<link rel="import" href="../unit-saved/unit-saved.html">
<link rel="import" href="../unit-properties/unit-properties.html">

<polymer-element name="x-app" vertical layout flex>
	<template>
		<style>
			:host {
				background:#eee;
			}

			.panel {
				margin:5px;
				border:1px solid #ccc;
				background-color: #eee;
			}

			core-toolbar {
				height:50px;
				background-color: navy;
				color:#fff;
				padding: 0 10px;
			}

			paper-tabs {
				background-color: #fff;
			}

			paper-tabs::shadow #selectionBar {
				background-color: red;
			}

			paper-tab::shadow #ink {
				color: red;
			}
		</style>

		<!--<core-toolbar class="core-narrow">
			Wardrobe
		</core-toolbar>-->

		<div horizontal layout flex>
			<div class="panel" vertical layout flex>

				<paper-tabs selected="{{navModeId}}">
					<paper-tab x-unit="browse" on-tap="{{navSelectTab}}"><text-string class="tab">navigation.tabs.browser</text-string></paper-tab>
					<paper-tab x-unit="saved" on-tap="{{navSelectTab}}"><text-string class="tab">navigation.tabs.saved</text-string></paper-tab>
				</paper-tabs>

					<div hidden?="{{navMode != 'browse'}}" class="tabbed-content" vertical layout flex>
						<unit-browse></unit-browse>
					</div>
					<div hidden?="{{navMode != 'saved'}}" class="tabbed-content" vertical layout flex>
						<unit-saved></unit-saved>
					</div>

			</div>

			<div class="panel" vertical layout>
				<unit-doll id="doll" instances="{{instances}}" canvasSize="{{dollCanvasSize}}"></unit-doll>
			</div>

			<div class="panel" vertical layout flex>
				<paper-tabs selected="{{propsModeId}}">
					<paper-tab x-unit="properties" on-tap="{{propsSelectTab}}"><text-string class="tab">navigation.tabs.properties</text-string></paper-tab>
				</paper-tabs>

				<div hidden?="{{propsMode != 'properties'}}" class="tabbed-content" vertical layout flex>
					<unit-properties data="{{currentObject}}" object="{{currentObjectType}}"></unit-properties>
				</div>

			</div>
		</div>

	</template>

	<script>
		Polymer({

			// POLYMER
			eventDelegates:{
				'instance-selected':'onInstanceSelected',
				'item-selected':'onItemSelected',
				'item-loaded':'onItemLoaded',
				'shelf-selected':'onShelfSelected',
				'model-selected':'onModelSelected',
				'agency-selected':'onAgencySelected'
			},

			created:function(){
				this.navModes = ['browse', 'saved'];
				this.navMode = this.navModes[this.navModeId];
				this.propsModes = ['properties'];
				this.propsMode = this.propsModes[this.propsModeId];

				app.currentState = {};

				this.currentObjectType = '';
				this.currentObject = {};
				this.current = {};
				this.initModel();
			},




			// TABS MANAGEMENT
			navModeId:0,
			propsModeId:0,

			navSelectTab:function(event, detail, sender){
				this.navMode = $(sender).attr('x-unit');
				this.navModeId = this.navModes.indexOf(this.navMode);
			},

			propsSelectTab:function(event, detail, sender){
				this.propsMode = $(sender).attr('x-unit');
				this.propsModeId = this.propsModes.indexOf(this.propsMode);
			},




			// ON SELECTED/UPDATED
			onAgencySelected:function(event, data){
				this.currentObjectType = 'agency';
				this.currentObject = this.current.agency = data;
				app.currentState.agency = data;
			},

			onModelSelected:function(event, data){
				if (!this.current.model || this.current.model.id != data.id){
					this.initModel(data);
					app.connection.get('default_items', {model:data.id}, this.selectDefaults.bind(this))
				}

				this.currentObjectType = 'model';
				this.currentObject = this.current.model = data;
				app.currentState.model = data;
			},

			onShelfSelected:function(event, data){
				this.currentObjectType = 'shelf';
				this.currentObject = this.current.shelf = data;
				app.currentState.shelf = data;
			},

			onItemSelected:function(event, data){
				app.currentState.item = data;
				this.current.item = data;

				this.subscribe();
			},

			onInstanceSelected:function(event, index){
				this.pushInstance(this.current.item.item.shelf_id, index)
			},



			//PROPS
			dollCanvasSize:1000,



			//MAIN CODE
			initModel:function(data){
				this.instances = [];

				if (typeof data != 'undefined'){
					this.dollCanvasSize = +data.size;
				}
			},

			selectDefaults:function(data){
				var newInstances = [];

				for (var i=0; i < data.length; i++) {
					var layer = data[i];
					var shelf_index = _(newInstances).findIndex({shelf:layer.shelf_id});
					layer.file = app.funcs.getFullFile(layer.file, layer.layer_id);

					if (shelf_index < 0) {
						newInstances.push({
							shelf: layer.shelf_id,
							layers:[layer]
						})
					} else {
						newInstances[shelf_index].layers.push(layer)
					}
				}

				this.instances = newInstances;
			},

			//ITEM SELECT QUEUE
			subscribe:function(){
				console.log('subscribe on', this.current.item.id);

				app.connection.subscribe(this, 'item-properties', {
					feed:'item_props',
					id: this.current.item.id
				}, this.parseItem)
			},

			parseItem:function(data){
				console.log('item loaded', data);

				_.each(data.instances, function(instance, i){
					instance.layers = [];

					_.each(data.layers, function(layer, l){

						var processedLayer = _(layer).clone();

						processedLayer.file = app.funcs.getFullFile(instance.file, layer.id);
						instance.layers.push(processedLayer);
					})
				});

				this.pushItem(data);
			},

			pushItem:function(data){
				// preserve instance on update
				data.activeInstance = this.current.item.activeInstance ? this.current.item.activeInstance : 0;

				this.currentObjectType = 'item';
				this.currentObject = this.current.item = data;
				app.currentState.item = data;

				this.pushInstance(data.item.shelf_id, this.current.item.activeInstance);
			},

			pushInstance:function(id, index){
				this.current.item.activeInstance = index;

				var i = _(this.instances).findIndex({shelf:id});

				var deleteCount = i >= 0 ? 1 : 0;

				this.instances.splice(i, deleteCount, {
					shelf:id,
					layers: this.current.item.instances[index].layers
				})
			}

		});
	</script>
</polymer-element>