<link rel="import" href="../image-layer/image-layer.html">

<polymer-element name="unit-doll" flex on-resize="{{ resize }}">
	<template>
		<style>
			:host {

			}

			::content .layer {
				position: absolute;
				background-color: red;
				width:100px;
				height: 100px;

			}

			#frame {
				background-color: #fff;
				position: relative;
				overflow: hidden;
				transform-origin: 0 0;
			}
		</style>

		<div id="frame">
			<template repeat="{{ layer in layers }}">
				<image-layer data="{{ layer }}"></image-layer>
			</template>
		</div>

	</template>

	<script>
		Polymer({
			canvasSize: 1000, // todo: 1000 is changeable var, depends on actor
			ratio:1,

			created:function(){
				var that = this;

				$(window).resize(function(){
					that.resize()
				})
			},

			attached:function(){
				this.initModel();
			},

			observe:{
				items:'createLayers'
			},

			initModel:function(data){
				this.layers = [];
				this.items = {};

				$(this.$.frame).width(this.canvasSize);
				$(this.$.frame).height(this.canvasSize);

				if (typeof data != 'undefined'){
					this.canvasSize = +data.size;
				}

				this.resize();
			},

			resize:function(){
				var that = this;

				// todo - make resizing snapped by 10px
				var frameSize = Math.min(this.offsetHeight, this.canvasSize);
				this.ratio = frameSize / this.canvasSize;

				$(this.$.frame).css('transform', 'scale('+ this.ratio +')');
				$(this).css('width', frameSize);
			},

			pushItem:function(data, instanceId){
				if (typeof instanceId == 'undefined') { instanceId = 0; }

				this.items[data.item.shelf_id] = data.instances[instanceId];

				this.createLayers();
			},

			createLayers:function(){
				var newLayers = [];

				_.each(this.items, function(instance){

					if (instance.layers){
						newLayers = newLayers.concat(instance.layers)
					}
				});

				this.layers = newLayers;
			}
		});
	</script>
</polymer-element>